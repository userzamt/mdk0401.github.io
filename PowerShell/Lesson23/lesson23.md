# Урок 23. Удаленный запуск сценариев

[На главную](/mdk0401.github.io)

Если вы единственный ИТ-специалист в небольшой организации, скорее всего, вы ответственны за несколько серверов. Когда у вас есть сценарий, который необходимо запустить, вы заходите на каждый сервер, открываете консоль PowerShell и запускаете его. Однако можно сэкономить кучу времени, если запустить всего один сценарий, который будет выполнять определенную задачу на каждом сервере. 

В этой лекции мы рассмотрим, как удаленно запускать команды с помощью инструментов PowerShell. 

**Удаленное управление PowerShell** — это инструмент, который позволяет пользователю удаленно запускать команды на одном или нескольких компьютерах одновременно. 

Сеанс, или, если точнее, сеанс `PSSession`, — это взаимодействие со средой PowerShell, запущенной на удаленном компьютере, с которого вы можете выполнять команды. 

> [!NOTE]
> Сотрудники корпорации Microsoft внедрили удаленное управление в версии *PowerShell v2*. Оно было создано на основе службы *Windows Remote Management (WinRM)*. По этой причине удаленное управление PowerShell иногда ассоциируют с термином **WinRM**.

Но прежде, поговорим о...

<!-- TODO необходимо проверить -->
## Удаленное взаимодействие с Windows PowerShell без настройки
Многие командлеты Windows PowerShell имеют параметр `ComputerName`, который позволяет собирать данные и изменять параметры одного или нескольких удаленных компьютеров. Эти командлеты используют разные протоколы связи и работают во всех операционных системах Windows без специальной настройки.

В эти командлеты входят следующие:

+ `Restart-Computer`
+ `Test-Connection`
+ `Clear-EventLog`
+ `Get-EventLog`
+ `Get-HotFix`
+ `Get-Process`
+ `Get-Service`
+ `Set-Service`
+ `Get-WinEvent`
+ `Get-WmiObject`

Обычно командлеты, которые поддерживают удаленное взаимодействие без специальной настройки, имеют параметр `ComputerName`, но не имеют параметра `Session`. Чтобы найти эти командлеты в сеансе, используйте следующую команду:

```powershell
Get-Command | Where-Object {
    $_.Parameters.Keys -contains "ComputerName" -and
    $_.Parameters.Keys -notcontains "Session"
}
```

## Удаленное взаимодействие Windows PowerShell
Функциональность удаленного выполнения команд в PowerShell называется PowerShell Remoting (появилась в PowerShell 2.0) и основана на возможностях протокола Web Services for Management (WS-Management). 

Благодаря использованию протокола WS-Management служба удаленного взаимодействия Windows PowerShell позволяет запустить любую команду Windows PowerShell на одном или нескольких удаленных компьютерах. Вы можете устанавливать постоянные подключения, запускать интерактивные сеансы и выполнять скрипты на удаленных компьютерах.

Чтобы использовать службу удаленного взаимодействия Windows PowerShell, удаленный компьютер должен быть настроен для удаленного управления. 

Для удаленного подключения к компьютеру через PowerShell на нем должна быть включена и настроена **WinRM** (служба удаленного управления Windows) (по умолчанию она отключена). Связь между компьютерами осуществляется по протоколам HTTP или HTTPS, а весь сетевой трафик между компьютерами зашифрован. 

Чтобы проверить состояние службы WinRM, выполните следующую команду

```powershell
Get-Service WinRM
```

Если служба не запущена, необходимо её запустить

```powershell
Start-Service WinRM
```

Либо воспользоваться командлетом `Enable-PSRemoting`

```powershell
Enable-PSRemoting
```

Командлет `Enable-PSRemoting` настраивает компьютер для получения удаленных команд PowerShell, отправляемых с помощью технологии WS-Management. 

> [!NOTE]
> На платформах Windows Server удаленное взаимодействие PowerShell по умолчанию включено. 

Эту команду необходимо выполнить только один раз на каждом компьютере, который будет принимать команды. Ее не нужно выполнять на компьютерах, которые только отправляют команды. Так как конфигурация запускает *прослушивание* для приема удаленных подключений.

> [!WARNING]
> Включение удаленного взаимодействия PowerShell в клиентских версиях Windows, если компьютер находится в общедоступной сети, обычно **запрещено**, но это ограничение можно пропустить с помощью параметра `SkipNetworkProfileCheck`. 

После настройки службы удаленного взаимодействия Windows PowerShell вы получите доступ ко многим стратегиям удаленного взаимодействия. 

## Работа с блоками сценариев
В удаленном управлении PowerShell широко используются блоки сценариев, которые, как и функции, представляют собой код, упакованный в единый исполняемый блок. Они отличаются от функций **парой важных деталей**: у них нет имени и их можно назначать переменным. 

Для создания блока сценария поместите код в фигурные скобки. Сохраним блок сценария в переменной. Вам может показаться, что для выполнения этого блока сценария можно просто вызвать переменную

```powershell
$block = { Write-Host "Hello, world" }
$block
```

PowerShell считывает содержимое переменной буквально, не понимая, что `Write-Host` — это команда, которую он должен выполнить. Вместо этого в консоли выводится содержимое блока сценария. 

Чтобы PowerShell запустил код внутри блока, вам нужно использовать символ `&`, за которым следует имя переменной.

```powershell
& $block
```

Этот символ сообщает PowerShell, что в фигурных скобках — это код, который надо выполнить. Это один из способов выполнения блока кода. Однако ему не хватает настроек, доступных для команд, которые вам понадобятся при работе с PowerShell на удаленных компьютерах.

## Использование команды Invoke-Command для выполнения кода на удаленных системах 
Команду `Invoke-Command` вы, вероятно, будете использовать чаще всего при удаленном управлении PowerShell. Существует два основных способа ее использования. Первый — для запуска так называемых *ad-hoc-команд* — небольших одноразовых выражений. Второй способ — для работы в интерактивных сеансах. 

Примером *ad-hoc-команды* является выполнение `Start-Service` для запуска службы на удаленном компьютере. Когда вы выполняете специальную команду с помощью `Invoke-Command`, PowerShell создает сеанс и разрывает его, как только команда будет выполнена. Это ограничивает разнообразие действий с `Invoke-Command`.

> [!IMPORTANT]
> Обратите внимание: для того чтобы Ваша команда сработала, оба компьютера должны быть частью одного домена *Active Directory (AD)*, при этом так же должны быть права администратора на удаленном компьютере

```powershell
Invoke-Command -ComputerName 250-prep -ScriptBlock {Get-Process} 
```

> [!WARNING]
> `Test-WSMan` - проверяет, запущена ли служба *WinRM* на локальном или удаленном компьютере.

Обратите внимание, что теперь вывод команды — это вывод с удаленного компьютера.

## Запуск локальных сценариев на удаленных компьютерах 
Команду `Invoke-Command` также можно использовать для выполнения целых сценариев. Вместо параметра `Scriptblock` вы можете прописать параметр `FilePath` и указать путь к сценарию на вашем компьютере. 

При использовании параметра `FilePath` команда `Invoke-Command` считает содержимое сценария локально, а затем выполнит его код на удаленном компьютере. Сам сценарий на удаленном компьютере при этом не выполняется. 

```powershell
Invoke-Command -ComputerName WEBSRV1 -FilePath C:\GetHostName.ps1
```

Команда `Invoke-Command` запускает код из сценария *GetHostName.ps1* на компьютере *WEBSRV1* и возвращает результат в ваш локальный сеанс.

## Удаленное использование локальных переменных 
В удаленном управлении PowerShell предусмотрено много полезного, однако следует проявлять осторожность при использовании локальных переменных. Допустим, у вас есть путь к файлу на удаленном компьютере — *C:\File.txt*. Поскольку в какой-то момент этот путь может измениться, вы помещаете его в переменную, например в `$serverFilePath`

```powershell
$serverFilePath = 'C:\File.txt'
```

Теперь вам может потребоваться указать путь *C:\File.txt* внутри блока сценария на удаленном хосте

```powershell
Invoke-Command -ComputerName WEBSRV1 -ScriptBlock { Write-Host "The value of foo is $serverFilePath" }
```

Обратите внимание, что у переменной `$serverFilePath` **нет значения**, потому что при выполнении блока сценария на удаленном компьютере **этой переменной вообще не существует!** Когда вы определяете переменную в сценарии или в консоли, эта переменная сохраняется в определенной области выполнения. Она является своего рода контейнером, который PowerShell использует для хранения информации во время сеанса. 

Переменные, функции и другие конструкции по умолчанию не распространяются на несколько пространств выполнения. Однако существует несколько методов, позволяющих это сделать. Есть два основных способа передачи переменных на удаленный компьютер.
