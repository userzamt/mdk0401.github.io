# Урок 18. Объединение команд

[На главную](/mdk0401.github.io)

До сих пор мы использовали консоль `PowerShell` для вызова команд по одной. Для простого кода это не проблема: вы запускаете нужную команду, а затем еще одну, если требуется. Но для более крупных проектов необходимость вызывать каждую команду по отдельности занимает слишком много времени. 

К счастью, вы можете комбинировать команды, чтобы вызывать их как единое целое. Существует два способа комбинирования команд — с помощью **конвейера** `PowerShell` и путем сохранения кода во внешних сценариях.

В большинстве оболочек командной строки, включая `cmd.exe`, под конвейеризацией понимается объединение нескольких команд путем последовательного перенаправления выходного потока одной команды во входной поток другой, что позволяет передавать текстовую информацию между разными процессами.

Механизм композиции команд представляет собой, вероятно, наиболее ценную концепцию, используемую в интерфейсах командной строки. Конвейеры не только снижают усилия, прилагаемые при вводе сложных команд, но и облегчают отслеживание выполняемых командами действий. 

Полезной чертой конвейеров является то, что они не зависят от числа передаваемых элементов, так как конвейер действует на каждый элемент отдельно. Кроме того, каждая команда в конвейере (называемая элементом конвейера) обычно передает свой вывод следующей команде в конвейере, элемент за элементом. Благодаря этому, как правило, снижается потребление ресурсов для сложных команд и появляется возможность получать выводимую информацию немедленно.

## Запуск службы Windows 
Чтобы показать, зачем стоит комбинировать команды, начнем с простого примера, который выполним по старинке. Будем использовать две команды: `Get-Service`, которая запрашивает службы Windows и возвращает информацию о них, и `Start-Service`, запускающую эти службы.

```powershell
Get-Service
```

```powershell
Start-Service 'wuauserv'
```

Когда вы запускаете только одну службу, выполнение таких команд не слишком напрягает. Но представьте, как вам это надоест, если речь пойдет о работе с сотнями сервисов.

> [!NOTE]
> Для остановки служб используется командлет `Stop-Service`

## Использование конвейера 
Первый способ упростить код — объединить команды в цепочку с помощью конвейера `PowerShell`. Это инструмент, который позволяет передавать выходные данные одной команды непосредственно во входные данные другой. 

Чтобы использовать конвейер, добавьте оператор вертикальной черты `|` между двумя командами

```powershell
команда1 | команда2 
```

Последняя команда конвейера будет выведена на консоль.

> [!NOTE]
>  Во многих языках сценариев оболочки, включая `cmd.exe` и `bash`, используется конвейер.

В оболочке `PowerShell` также очень широко используется механизм конвейеризации команд, однако здесь по конвейеру передается **не поток текста**, как во всех других оболочках, **а объекты**. При этом с элементами конвейера можно производить различные манипуляции: фильтровать объекты по определенному критерию, сортировать и группировать объекты, изменять их структуру.

```powershell
Get-Service -Name 'wuauserv' | Start-Service
```

Уже не нужно указывать какие-либо параметры, потому что `PowerShell` сделает это за вас. Система просмотрит выходные данные `Get-Service`, поймет, какие значения следует передать в `Start-Service`, и сопоставит значения с параметрами, которые `Start-Service` принимает на вход.

При желании можно переписать конвейер вообще без параметров

```powershell
'wuauserv' | Get-Service | Start-Service
```

Для анализа структуры объекта, возвращаемого определенной командой, проще всего направить этот объект по конвейеру на командлет `Get-Member`

```powershell
'wuauserv' | Get-Service | Get-Member
```

## Передача массивов между командами
Вариант передачи массива данных по конвейеру

```powershell
'aspnet_state','PeerDistSvc','CDPSvc' | Get-Service
```
Удобнее использовать для таких целей текстовый файл. В папке с лекцией есть текстовый файл *services.txt*, в котором содержится перечень служб. Чтобы отобразить файл в окне `PowerShell`, используйте командлет `Get-Content`

```powershell
Get-Content -Path C:\services.txt 
Get-Content services.txt 
```

Команда `Get-Content` читает файл построчно, добавляя каждую строку в массив, который затем возвращает.

```powershell
Get-Content services.txt | Get-Service
```

Команда `Get-Content` читает текстовый файл и выдает массив. Но вместо того, чтобы отправлять через конвейер сам массив, `PowerShell` разворачивает его и прогоняет каждый элемент через конвейер по одному. Это позволяет выполнять одну и ту же команду для каждого элемента в массиве. 

Поместив каждую службу для запуска в текстовый файл и добавив приписку `| Start-Service` к команде, то получится команда, которая сможет запустить сколько угодно служб. 

Ограничений на количество команд, которые вы можете *«склеить»* с помощью конвейера, нет. Но если вы заметите, что их число превысило пять, вам, возможно, придется пересмотреть подход. Обратите внимание, что конвейер — это мощный инструмент, но он будет работать не всегда: большинство команд `PowerShell` **принимают только определенные типы входных данных** из конвейера, **а некоторые не принимают вообще** никаких. 

