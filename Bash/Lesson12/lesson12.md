# Урок 12. sed и обработка текстов

[На главную](/mdk0401.github.io)

**Sed** (от англ. Stream EDitor) — консольная утилита для редактирования текстовых потоков.

Sed неинтерактивный строчный редактор, который принимает текст либо с устройства `stdin`, либо из текстового файла, выполняет некоторые операции над строками и затем выводит результат на устройство `stdout` или в файл. 

Как правило, в сценариях, `sed` используется в конвейерной обработке данных, совместно с другими командами и утилитами.

```bash
sed OPTIONS... [SCRIPT] [INPUTFILE...]
```

Утилиту `sed` называют **потоковым текстовым редактором**. В интерактивных текстовых редакторах, наподобие `nano`, с текстами работают, используя клавиатуру, редактируя файлы, добавляя, удаляя или изменяя тексты. `Sed` позволяет редактировать потоки данных, основываясь на заданных разработчиком наборах правил. 

## Отличие от других редакторов
Раньше текстовые файлы просматривались/обрабатывались построчно, т.е. пользователь, работая на терминале, не видел содержимого целиком, и строка за строкой делал свои изменения. С другой стороны, текст мог поступать на терминал порциями и получался тот же эффект. Во всех этих случаях поступающий текст образует поток символов (*stream*).

Команда `Sed` позволяет определить некоторые правила обработки (написать микропрограмму обработки) для каждой строки в потоке, и в этом собственно ее основная функция. Правила обработки составляется на внутреннем языке `Sed`, который объявляет специальные команды по типу заменить, удалить, подставить и т.п. Составляя из этих команд комбинации, можно писать очень сложные процедуры обработки, которые покрывают большую часть потребностей, встречающихся на практике. 

> [!IMPORTANT]
> У языка `Sed` есть недостаток в том, что он не такой очевидный и иногда сложный, и не посвященному пользователю он будет не понятен.

К типичным задачам `Sed` можно отнести следующие:

+ Вывод исходного файла фрагментами;

+ Замена подстрок в файле по регулярным выражениям;

+ Удаление/Вставка/Изменение фрагментов исходного текста файла по некоторым правилам, в частности, Sed довольно часто используют для автоматизированной правки конфигурационных файлов системы.

Более мощной альтернативой `Sed` является консольная утилита `Awk`, смысл которой такой же, но язык написания правил обработки сложнее и богаче. Однако, практика показывает, что сначала нужно попробовать решить задачу с помощью `Sed`, вместо того, чтобы *«стрелять по воробьям из базуки»*. 

## Введение в синтаксис
По умолчанию sed применяет указанные при вызове правила, выраженные в виде набора команд, к `STDIN`. Это позволяет передавать данные непосредственно `sed`.

```bash
echo "This is a test" | sed 's/test/another test/'
```

В данном случае `sed` заменяет слово *«test»* в строке, переданной для обработки, словами *«another test»*. Для оформления правила обработки текста, заключённого в кавычки, используются прямые слэши. В нашем случае применена команда вида `s/pattern1/pattern2/`. 

Буква *«s»* — это сокращение слова *«substitute»*, то есть — перед нами команда замены. `Sed`, выполняя эту команду, просмотрит переданный текст и заменит найденные в нём фрагменты (о том — какие именно, поговорим ниже), соответствующие `pattern1`, на `pattern2`.

Выше приведён примитивный пример использования `sed`, нужный для того, чтобы ввести вас в курс дела. На самом деле, `sed` можно применять в гораздо более сложных сценариях обработки текстов, например — для работы с файлами.

```bash
sed 's/test/another test' ./myfile
```

Здесь применён тот же подход, который использовался выше, но теперь `sed` обрабатывает текст, хранящийся в файле. При этом, если файл достаточно велик, можно заметить, что `sed` обрабатывает данные порциями и выводит то, что обработано, на экран, не дожидаясь обработки всего файла.

**`Sed` не меняет данные в обрабатываемом файле.** Редактор читает файл, обрабатывает прочитанное, и отправляет то, что получилось, в `STDOUT`. 

При необходимости вывод `sed` можно перенаправить в файл, возможно — перезаписать старый файл.

## Базовый вызов
Утилита `Sed` в базовом виде выглядит примерно так

```bash
sed 'pattern' file1 file2 .... fileN
```

В данном случае правила выполнятся для каждого переданного файла. Если вы не передадите ни одного файла, то утилита перейдет **в интерактивный режим** и будет применять правила выборки для всего, что напишет пользователь в консоль. 

> [!NOTE]
> Интерактивный режим полезен при отладке, если планируется использовать `Sed` в сценарии.

Вообще утилита `Sed` ждет данные в свой `STDIN` поток, т.е. в командной оболочке данные для `Sed` можно передавать через конвейеры и/или дескрипторы

```bash
# Передача данных через конвейер
echo "Text fragment" | sed 'p'

# Передача данных через STDIN (первый вариант)
sed 'p' <<EOF
Text fragment
EOF

# Передача данных через STDIN (второй вариант)
sed 'p' <<< "Text fragment"

# Передача данных через дескриптор (первый вариант)
sed 'p' < file.txt
# аналогично
sed 'p' file.txt
```
> [!WARNING]
> Если `Sed` было передано больше одного файла за один раз, то по умолчанию идет обработка их конкатенации (то есть одного большого потока). Чтобы отменить это поведение и обрабатывать файлы по отдельности, используйте опцию `-s` или `--separate`. 

Sed обрабатывает каждую строку в три шага:

1. Сначала помещает входящую строку в буфер, называемый *pattern space*.

1. Применяет к строке все инструкции. Все это делается в одном буфере *pattern space*.

1. Печатает полученный результат из буфера в свой `STDOUT`.

### Устройство команд
В языке `Sed` можно выделить следующие смысловые части:

+ **Адресация конкретной строки**. Позволяет выбирать из потока только отдельно указанные строки, либо строки, которые соответствуют регулярному выражению.

+ **Диапазон**. Диапазон указывает `Sed` какие строки нужно выбирать перед обработкой. В `Sed` есть несколько способов указать диапазон: можно указать выбираемые строки через числа, а можно через регулярные выражения. Если диапазон никак не указан явно, то `Sed` обрабатывает весь поток целиком.

+ **Команда**. Собственно сама команда, которая исполняется над диапазоном. Команды могут быть сгруппированы через блок. Внутри блока команды отделяются точкой с запятой `;`.

```bash
### Одна команда
<команда>

# Пример
sed -n 'p' test.txt

### Одна команда с диапазоном, на который она направлена
<адресация или диапазон> <команда>

# Пример
sed -n '1 p' test.txt   # адресация первой строки
sed -n '2,8 p' test.txt   # числовой диапазон

# Обратите внимание, что диапазон прикрепляется только к следом идущей команде.
sed -n '1 p ; p' test.txt
# В предыдущем примере две команды разделены ';'. Адресация относится только к первой команде 'p', но не второй.
# Так как для  второй печати диапазон не указан явно, то по умолчанию она будет печатать весь поток.
# Микропрограмма напечатает сначала первую строку, а потом напечатает все строки фрагмента.

### Блок
# Чтобы отнести адресацию или диапазон к нескольким командам, вы должны объединить их в блок через фигурные скобки.

<адресация или диапазон> { <команда1> ; <команда2> ...; <командаN> } 

# Примеры
sed -n '1 { p ; p }' test.txt   # Напечатать два раза первую строку
sed -n '1,3 { p ; p }' test.txt # Напечатать два раза первые три строки

# Как и простые команды, блоки разделяются ;. Если перед блоком стоит адресация или диапазон, то он относится только к
# следующему за ним блоку.

sed -n '1,3 { p ; p } ; 1,2 { p ; p } ; {p ; p}' test.txt
```

> [!NOTE]
> Пробелы в общем случае между отдельными частями не нужны, так как все команды и синтаксические якоря состоят из одного символа, однако пробелы повышают удобочитаемость кода. 

## Выполнение наборов команд
Для выполнения нескольких действий с данными, используйте ключ `-e` при вызове `sed`. 


```bash
sed -e 's/This/That/; s/test/another test/' ./myfile
```

Для ввода нескольких шаблонов обработки текста при вызове `sed`, можно, после ввода первой одиночной кавычки, нажать `Enter`, после чего вводить каждое правило с новой строки, не забыв о закрывающей кавычке

```bash
$ sed -e '
> s/This/That/
> s/test/another test/' ./myfile
```

## Чтение команд из файла
Если имеется множество команд sed, с помощью которых надо обработать текст, обычно удобнее всего предварительно записать их в файл. Для того, чтобы указать `sed` файл, содержащий команды, используют ключ `-f`

Вот пример файла с командами:
```
s/This/That/
s/test/another test/
```

Вызовем `sed`, передав редактору файл с командами и файл для обработки:

```bash
sed -f mycommands myfile
```

Результат при вызове такой команды аналогичен тому, который получался в предыдущих примерах.



