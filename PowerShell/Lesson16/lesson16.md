# Урок 16. PowerShell. Типы данных

[На главную](/mdk0401.github.io)

Необходимо рассмотреть четыре основных понятия, связанных с `PowerShell`: переменные, типы данных, объекты и структуры данных. 

Эти понятия фундаментальны практически для каждого языка программирования, но в `PowerShell` есть еще кое-что, отличающее его от других языков: в нем **все является объектом**.

Но перед этим...

## Работают ли знакомые команды?
Все команды, к которым вы привыкли (например, cd, dir и cls), также работают в PowerShell. 

```powershell
dir
ls
```

По сути, эти *«команды»* на самом деле являются не командами, а их псевдонимами, благодаря которым `PowerShell` и понимает эти команды. 

```powershell
cd C:\
Set-Location C:\
```

Узнать какие команды `cmd.exe` работают в `PowerShell` можно с помощью `Get-Alias`

```powershell
Get-Alias
Get-Alias cd
Get-Alias pwd
```

## Типы команд 
В оболочке `cmd.exe` все команды разделялись на внутренние, которые распознавались и выполнялись непосредственно интерпретатором `cmd.exe`, и внешние, которые представляли  собой отдельные исполняемые модули. К внутренним относятся, например, команды `dir` и `copy`, а к внешним — `xcopy` и `more`. Кроме этого, оболочка `cmd.exe` поддерживает сценарии — **командные файлы**. 

В оболочке `PowerShell` поддерживаются команды четырех типов: 
+ командлеты
+ функции
+ сценарии
+ внешние исполняемые файлы.

### Командлеты 
Командлет представляет собой класс .NET, порожденный от базового класса `Cmdlet`. Единый базовый класс `Cmdlet` гарантирует совместимый синтаксис всех командлетов, а также автоматизирует анализ параметров командной строки и описание синтаксиса командлетов, выдаваемое встроенной справкой. 

Командлеты можно считать в определенном смысле аналогом внутренних команд традиционных оболочек, хотя в отличие от внутренних команд новые командлеты могут быть добавлены в систему в любое время.

```powershell
Get-Command
```

### Функции 
Функция — это блок кода на языке `PowerShell`, имеющий название и находящийся в памяти до завершения текущего сеанса командной оболочки. Анализ синтаксиса функции производится только один раз при ее объявлении (при повторном запуске функции подобный анализ не проводится). 

> [!NOTE]
> Более подробно функции разберутся в другой лекции

### Сценарии 
Сценарий представляет собой блок кода на языке `PowerShell`, хранящийся во внешнем файле с расширением `ps1`. Анализ синтаксиса сценария производится при каждом его запуске. Сценарии позволяют работать с `PowerShell` в пакетном режиме, то есть заранее создать файл с нужными командами, определить логику работы с помощью различных управляющих инструкций языка `PowerShell` и пользоваться этим файлом как исполняемым модулем.

Существуют системные политики, ограничивающие выполнение скриптов. Можно проверить текущие параметры политики, введя команду Get-ExecutionPolicy.

```powershell
Get-ExecutionPolicy
```

Результатом будет одно из следующих значений:

+ **Restricted** — выполнение скриптов запрещено. Стандартная конфигурация;
+ **AllSigned** — можно запускать скрипты, подписанные доверенным разработчиком; перед запуском скрипта `PowerShell` запросит у вас подтверждение;
+ **RemoteSigned** — можно запускать собственные скрипты или те, что подписаны доверенным разработчиком;
+ **Unrestricted** — можно запускать любые скрипты.

Для начала работы необходимо изменить настройку политики запуска на RemoteSigned, используя команду `Set-ExecutionPolicy`(в режиме Администратор)

```powershell
Set-ExecutionPolicy RemoteSigned
```

### Внешние исполняемые файлы 
Последний тип команд, запускаемых в `PowerShell`, — внешние исполняемые файлы, которые выполняются операционной системой обычным образом. В частности, из оболочки `PowerShell` можно запускать любые внешние команды интерпретатора `cmd.exe` (например, `xcopy`), просто указывая их имена.

## Диски PowerShell 
Все мы давно привыкли к структуре файловой системы как совокупности вложенных папок (каталогов) и файлов. В операционной системе Windows интерфейс к такой структуре предоставляют Проводник Windows, оболочка `cmd.exe`, а также различные файловые менеджеры сторонних разработчиков. 

В UNIX-системах понятия файлов и папок трактуются более широко, в качестве файлов здесь могут выступать различные компоненты системы (например, аппаратные устройства или сетевые подключения). Такой подход упрощает поиск нужных элементов в операционной системе. Оболочки командной строки или другие утилиты, обращающиеся к файлам в UNIX-системах, могут работать также и с этими компонентами. 

Оболочка `PowerShell` в этом аспекте похожа на UNIX-системы, так как она позволяет просматривать различные хранилища данных и перемещаться по ним с использованием тех же привычных процедур, которые применяются для перемещения по файловой системе. Помимо обычных локальных или сетевых дисков файловой системы (C:, D: и т. д.) оболочка поддерживает специальные (виртуальные) диски `PowerShell`, связанные с хранилищами данных разных типов.

> [!IMPORTANT]
> В отличие от обычных локальных или сетевых дисков файловой системы диски
`PowerShell` доступны только из оболочки `PowerShell`, обратиться к ним из Проводника Windows нельзя. Имена дисков `PowerShell` могут содержать более одного символа. 

```powershell
Get-PSDrive
```

Командлет `Get-PSDrive` для каждого диска сообщает имя провайдера (колонка *Provider*), поддерживающего этот диск. 

```powershell
Set-Location HKLM:\
```

**Провайдер** `PowerShell` — это .NET-приложение, предоставляющее пользователям `PowerShell` доступ к данным из определенного специализированного хранилища в согласованном формате, напоминающем формат обычных дисков файловой системы. Тем самым провайдеры `PowerShell` обеспечивают доступ к данным, к которым трудно обратиться через командную строку иными способами.

| Провайдер | Хранилище данных |
| :--: | :-- |
| **Alias** | Псевдонимы PowerShell |
| **Certificate** | Сертификаты X509 для цифровых подписей |
| **Environment** | Переменные среды Windows |
| **FileSystem** | Диски файловой системы, каталоги и файлы |
| **Function** | Функции PowerShell |
| **Registry** | Реестр Windows |
| **Variable** | Переменные PowerShell |

```powershell
Get-PSProvider
```

## Вычисление выражений 
Кроме выполнения команд, в `PowerShell` можно вычислять выражения, то есть пользоваться оболочкой как калькулятором (в оболочке `cmd.exe` эта возможность отсутствовала).

```powershell
32-58*(67-9)
25 % 9
10 / 3
```

В `PowerShell` можно выполнять и более сложные вычисления, включающие в себя различные математические функции. Для этого используются методы .NET-класса `System.Math`.

```powershell
[System.Math]::Pow(2,4)
[System.Math]::Sqrt(144)
[System.Math]::PI
```

## Переменные
**Переменная** — это место для хранения значений.

Все переменные в `PowerShell` начинаются со знака доллара `$`, который сообщает `PowerShell`, что  вызывается именно переменная, а не командлет, функция, файл сценария или исполняемый файл.

```powershell
$MaximumHistoryCount
```

`$MaximumHistoryCount` — это встроенная переменная, которая определяет максимальное количество команд, которое `PowerShell` сохраняет в своей истории. 

```powershell
$MaximumHistoryCount = 400
```

### Пользовательские переменные
```powershell
$color
```

> [!WARNING]
> Если после выполнения не получили сообщение об ошибке, и в консоли не выводится никаких данных, необходимо выполнить следующую команду, чтобы включить строгий режим: `Set-StrictMode -Version Latest`
> Включение этого режима заставляет `PowerShell` выдавать информацию об ошибке, если вы нарушаете правила написания кода. Например, строгий режим вынуждает `PowerShell` возвращать ошибку при обращении к несуществующему свойству объекта или к не определенной ранее переменной. Считается, что лучше включать этот режим при написании сценариев, поскольку так вы будете писать более чистый и предсказуемый код.

```powershell
$color = 'red'
```

Когда используется знак равенства для определения переменной, выполняется то же самое, что и команда `Set-Variable`. 

```powershell
Set-Variable -Name var -Value 45.56768
```

Аналогично, когда вы вводите в консоли переменную и получаете значение, вы делаете то же, что и с помощью команды `Get-Variable`. 

```powershell
Get-Variable -Name color
```

Эта команда так же выводит список всех переменных, в настоящее время находящихся
в памяти.

```powershell
Get-Variable
```

### Переменные оболочки `PowerShell`
**Переменные оболочки** — это набор переменных, которые создаются, объявляются оболочкой `PowerShell` и присутствуют по умолчанию в каждом сеансе работы. 

Переменные оболочки сохраняются в течение всего сеанса и доступны всем командам, сценариям и приложениям, которые выполняются в данном сеансе. 

Поддерживаются два вида переменных оболочки
+ **Автоматические переменные.** В этих переменных хранятся параметры состояния оболочки `PowerShell`. Автоматические переменные сохраняются и динамически изменяются самой системой. Пользователи не могут (и не должны) изменять значения этих переменных. 

```powershell
$PID
```

+ **Переменные настроек**. В этих переменных хранятся настройки активного пользователя. Эти переменные создаются оболочкой PowerShell и заполняются значениями по умолчанию. Пользователи могут изменять значения этих переменных. Например, переменная `$MaximumHistoryCount` определяет максимальное число записей в журнале сеанса. 

```powershell
Get-Variable
```

Переменными оболочки можно пользоваться так же, как и другими видами
переменных.

```powershell
ls $PSHOME 
```

```powershell
Get-Process -Id $PID
```

Переменная `$null` немного странная: она ничего не представляет. Присвоение значения `$null` другой переменной позволяет создать эту переменную, но не присваивает ей реального значения

```powershell
$color
$test = $null
Get-Variable test
```

Еще одна часто используемая встроенная переменная — `$LASTEXITCODE`. `PowerShell` позволяет запускать внешние исполняемые приложения вроде старого доброго `ping.exe`. Когда внешние приложения завершают работу, они заканчиваются с кодом выхода, или кодом возврата, который имеет определенное значение. Как правило, 0 означает удачный исход, а что-либо другое — сбой или аномалию. Для приложения `ping.exe` ответ 0 означает, что связь с узлом удалось успешно проверить, а 1 — что ничего не получилось.

```powershell
PING.EXE 77.88.8.7
$LASTEXITCODE
```

## Переменные среды Windows 
Кроме собственных переменных, оболочка `PowerShell` позволяет работать и с переменными среды (или переменными окружения) Windows, каждая из которых хранится в оперативной памяти в течение всего сеанса работы операционной системы, имеет свое уникальное имя, а ее значением является строка. Стандартные переменные среды автоматически инициализируются в процессе загрузки операционной системы. К таким переменным относятся, например, `WINDIR`, которая определяет расположение каталога Windows, `TEMP`, которая определяет путь к каталогу для хранения временных файлов Windows или `PATH`, в которой хранится системный путь (путь поиска), то есть список каталогов, в которых система должна искать выполняемые файлы или файлы совместного доступа (например, динамические библиотеки).

В оболочке `PowerShell` доступ к переменным среды можно получить через виртуальный диск `Env:`

```powershell
ls env:
dir Env:
Get-ChildItem Env:
```

Для получения значения определенной переменной среды нужно перед ее именем указать префикс `env:`. Например, следующая команда выведет на экран путь к корневому каталогу операционной системы, который хранится в переменной среды `SystemRoot`

```powershell
$env:SystemRoot
```

