# Урок 21. Модули

[На главную](/mdk0401.github.io)

`PowerShell`-модуль в чистом виде представляет собой текстовый файл с расширением `.psm1` и дополнительными метаданными. 

Существуют и другие типы — бинарные модули и динамические модули, но эти понятия выходят за рамки данного урока. 

Любая команда, которая явным образом не выполнялась в сеансе работы `PowerShell`, почти наверняка исходит из модуля. Многие  команды являются частью встроенных модулей *Microsoft*, которые идут в комплекте с `PowerShell`. Помимо них также бывают сторонние модули, в том числе те, которые вы сами создаете. Чтобы использовать модуль, его сначала нужно **установить**. Затем, если необходимо использовать команду из модуля, сам модуль должен быть **импортирован** в ваш сеанс. Начиная с версии *PowerShell v3*, **среда автоматически импортирует модуль** при попытке вызвать из него команду. 

## Поиск модулей в сеансе
Просмотреть импортированные в текущий сеанс модули можно с помощью командлета `Get-Module` (который сам является частью модуля). Это команда, которая позволяет просмотреть все имеющиеся в системе модули, доступные в текущем сеансе.

```powershell
Get-Module
```

Каждая строка выходных данных команды `Get-Module` представляет собой модуль, который был импортирован в текущий сеанс. Это означает, что все команды этого модуля можно использовать в любой момент. Модули `Microsoft.PowerShell.Management` и `Microsoft.PowerShell.Utility` по умолчанию импортируются в любой сеанс `PowerShell`. 

Обратите внимание на столбец `ExportedCommands`. Это те команды из модуля, которые вы можете использовать. Все варианты можно посмотреть с помощью `Get-Command` с указанием имени модуля. 

```powershell
Get-Command -Module Microsoft.PowerShell.Management
```

Здесь перечислены все команды, которые были экспортированы из этого модуля — их можно вызвать и вне его. Некоторые авторы любят включать в свои модули функции, недоступные для пользователя. Любая функция, которая не экспортируется и работает только внутри сценария или модуля, называется **приватной функцией** или, как иногда говорят, **вспомогательной функцией**. 

Использование команды `Get-Module` без каких-либо параметров вернет все импортированные модули, но **что насчет модулей, которые были установлены, но не импортированы?**

## Поиск модулей на компьютере
Чтобы вывести список всех модулей, которые установлены в системе и могут быть импортированы в ваш сеанс, можно использовать команду `Get-Module` с параметром `-ListAvailable`

```powershell
Get-Module -ListAvailable
```

Параметр `ListAvailable` просит `PowerShell` проверить наличие в папках вложенных папок с файлами `.psm1`. `PowerShell` прочитает каждый из этих модулей в файловой системе и вернет вам имя, метаданные и список функций каждого модуля, которые можно использовать. 

`PowerShell` ищет модули в нескольких местах на жестком диске, заданных по умолчанию типом модуля:

+ **Системные модули**: почти все модули, которые идут в комплекте с `PowerShell`, будут расположены в папке *C:\Windows\System32\WindowsPowerShell\1.0\Modules*. Этот путь обычно используется только для внутренних PowerShell-модулей. В принципе, вы можете размещать в этой папке и свои модули, но делать это не рекомендуется. 

+ **Модули, доступные всем пользователям**: модули также хранятся в папке *C:\Program Files\WindowsPowerShell\Modules*. Этот путь обычно называют путем *«Для всех пользователей»*, и именно здесь находятся все модули, которые должны быть доступны всем пользователям системы. 
+ **Модули текущего пользователя**: наконец, вы можете хранить модули в папке *C:\Users\<ТекущийПользователь>\Documents\WindowsPowerShell\Modules*. Внутри этой папки вы найдете все созданные или загруженные вами модули, которые доступны только текущему пользователю. Размещение модулей по этому пути позволяет разделить их на случай, если за компьютером работают несколько пользователей.

При вызове команды `Get-Module -ListAvailable` PowerShell считывает все пути к этим папкам и возвращает все расположенные там модули. Тем не менее это лишь пути для модулей по умолчанию — при необходимости вы можете добавить свои.

Можно создать новый путь к модулю с помощью переменной среды `$PSModulePath`, в которой определены все папки с модулями. Они разделены точкой с запятой

```powershell
$env:PSModulePath -split ';'
```

> [!IMPORTANT]
> Вы можете добавить свою папку с модулями в переменную среды `PSModulePath`, но имейте в виду, что в этом случае новая папка добавится только в текущий сеанс.

## Импорт модулей
Если путь к папке модуля уже помещен в переменную среды `PSModulePath`, вам остается лишь импортировать его в текущий сеанс. Сейчас у `PowerShell` есть функция автоматического импорта, и, если у вас установлен модуль, просто вызовите нужную функцию, а `PowerShell` **автоматически** ее туда **импортирует**.

Тем не менее важно понимать саму процедуру импорта.
Давайте воспользуемся встроенным модулем под названием `NetAdapter`. 

> [!NOTE]
> [Microsoft learn NetAdapter](https://learn.microsoft.com/en-us/powershell/module/netadapter/?view=windowsserver2022-ps)

В запускаем команду `Get-Module` дважды: один раз в новом сеансе PowerShell 

```powershell
Get-Module
```

и еще один раз  после использования команды `Get-NetAdapter`, из модуля `NetAdapter`. 

```powershell
Get-NetAdapter
Get-Module
```

Как видите, модуль `NetAdapter` автоматически импортировался после использования команды. Функция автоматического импорта обычно справляется сама. Если команда внутри модуля по какой-то причине недоступна, то, вероятно, есть проблема с модулем.

Чтобы вручную импортировать модуль, используйте команду `Import-Module`

```powershell
Import-Module -Name NetAdapter

Import-Module -Name NetAdapter -Verbose
```

Использование ключа `-Verbose` приводит `Import-Module` к выводу отчета о ходе загрузки модуля.

Команда `Remove-Module` выгружает модуль из сеанса.

```powershell
Remove-Module -Name NetAdapter
```

Так же допустимо импортировать только те функции из модуля, которые необходимы

```powershell
Import-Module -Name NetAdapter -Function Get-NetAdapter
```

В этом примере импортируются все доступные модули по пути, указанном переменной `$env:PSModulePath` среды, в текущий сеанс.

```powershell
Get-Module -ListAvailable | Import-Module
```

## Структурирование модулей PowerShell
Теперь давайте посмотрим, как устроены PowerShell-модули изнутри.

Вместо того, чтобы определять все ваши функции в одном `.psm1` сценария PowerShell, вы можете разбить свою функцию на отдельные файлы. Затем вы можете передать эти файлы из вашего файла модуля скрипта, что, по сути, относится к ним так, как если бы они были частью самого файла `.psm1`. 

```
\MyModule
  \Functions
    Function1.ps1
    Function2.ps1
    Function3.ps1
    ...
MyModule.psd1
MyModule.psm1
```

### Файл .psm1
Любой текстовый файл с расширением .psm1 может быть PowerShell-модулем. Но чтобы этот файл делал что-то полезное, в нем должны быть функции. Все функции внутри модуля лучше строить вокруг некоторой общей концепции.

```powershell
function Get-Software {  ...  }

function Install-Software {  ...  }

function Remove-Software {  ...  }
```

Обратите внимание, что в имени каждой команды существительные повторяются — изменяется только глагол. При создании модулей так делать лучше всего. Если вам нужно изменить существительное, возможно, стоит разбить один модуль на несколько.

### Манифест модуля
Помимо файла `.psm1` у модуля также есть манифест или файл `.psd1`. 

**Манифест модуля** — это текстовый файл, написанный в виде хеш-таблицы PowerShell. Это не обязательный, но рекомендуемый элемент. Эта хеш-таблица содержит метаданные о модуле.

> [!NOTE]
> Манифест - описывает автора модуля, дату его создания, ссылку на модуль и т.д.

> [!IMPORTANT]
> Манифест это так же важная часть, которая должна быть создана, если вы планируете опубликовать свой модуль в публичный репозиторий Powershell. 

Можно создать манифест модуля с нуля, но в `PowerShell` есть команда `New-ModuleManifest`, которая может сгенерировать для вас шаблон. 

```powershell
New-ModuleManifest -Path 'C:\Program Files\WindowsPowerShell\Modules\Software\Software.psd1'
```

> [!WARNING]
> Манифест подразумевает создание дополнительного файла по тому же пути что и сам модуль. Название модуля, папки и файла манифеста должны совпадать. Расширение манифеста должно быть `psd1`.

После запуска команды вы увидите, что там есть много полей, для которых не указаны параметры. Мы не будем углубляться в манифесты модулей. На данный момент вам достаточно знать о необходимости определять как минимум параметры `RootModule`, `Author`, `Description` и, возможно, `Version`. Все эти атрибуты необязательны, но вам стоит завести привычку добавлять как можно больше информации в манифест модуля.

### Справка
Справка - описывает принцип работы с функцией/командой.

Справка в Powershell описывает работу не модуля, а функции/команды.

Сама справка описывается внутри модуля у каждой функции отдельно. Обычно используется следующий шаблон

```powershell
function Some-Funct(){
<#
	    .SYNOPSIS
	    Returns registry key using provided path.
	    .DESCRIPTION
	    The function uses the Get-Item command to return the information for a provided registry key.
	    .PARAMETER Path
	    The path that will be searched for a registry key.
	    .EXAMPLE
	    Get-RegistryKey -Path 'HKLM:\HARDWARE\DESCRIPTION\System'
	    .INPUTS
	    System.String
	    .OUTPUTS
	    Microsoft.Win32.RegistryKey
	    .NOTES
	    This module is an example of what a well documented function could look.
	    .LINK
	    https://fixmypc.ru
#>
   return "Pass"
}
```

## Поиск модулей
Одно из лучших свойств модулей — это возможность делиться ими: зачем тратить время на решение уже решенной задачи? Скорее всего, оно уже есть в *PowerShell Gallery*. 

[PowerShell Gallery](https://www.powershellgallery.com) — это репозиторий тысяч модулей и сценариев PowerShell. Их может загружать любой пользователь, у которого есть учетная запись. 

В репозитории есть различные модули, которые создают как обычные люди, так и корпорации вроде Microsoft.

В `PowerShell` есть встроенный модуль `PowerShellGet`, где можно найти простые команды для взаимодействия с *PowerShell Gallery*. 

В модуле `PowerShellGet` есть команды для поиска, сохранения и установки чужих модулей, а также для публикации своих. 

```powershell
Get-Command -Module PowerShellGet
```
Для поиска в *PowerShell Gallery* модуля с определенным именем воспользуйтесь командой `Find-Module`. 

```powershell
Find-Module -Name *VMware*
```
> [!NOTE]
> Команда `Find-Module` ничего не загружает, а просто показывает вам, что есть в *PowerShell Gallery*.

## Установка модулей
Если вы хотите установить модуль, воспользуйтесь командой `Install-Module`. 

```powershell
Install-Module -Name SimpySql
```

> [!WARNING]
> Обратите внимание, что вы можете получить предупреждение о ненадежном репозитории. Чтобы избавиться от них, укажите `PowerShell` доверять всем пакетам внутри этого репозитория. В противном случае вам будет предложено запустить команду `Set-PSRepository`, чтобы вручную задать политику установки для этого репозитория.

Команда загрузит модуль и поместит его в расположение модулей **All Users** в папке *C:\Program Files\WindowsPowerShell\Modules*. 

```powershell
Get-Module -Name SimpySql | Select-Object –Property ModuleBase
```

## Деинсталляция модулей
Новичков в `PowerShell` часто смущает разница между удалением и деинсталляцией модуля. Как говорилось ранее, команда `Remove-Module` позволяет удалить модуль из сеанса `PowerShell`. Но она лишь **выгружает модуль** из сеанса, а **не удаляет** его с диска.

Для удаления — **деинсталляции** — модуля воспользуйтесь командлетом `Uninstall-Module`. 

```powershell
Uninstall-Module -Name SimpySql
```

Команда `Uninstall-Module` позволяет **удалять только модули, загруженные из PowerShell Gallery**, — встроенные все равно останутся!

## Создание собственного модуля
Пока что мы работали только с модулями, которые писали другие люди. Конечно же, одна из потрясающих особенностей модулей PowerShell заключается в том, что вы можете создавать свои модули и делиться ими со всем миром.

Типичный PowerShell-модуль состоит из папки (контейнер
модуля), файла `.psm1` (самого модуля) и файла `.psd1` (манифеста модуля).

Если папка модуля находится в одном из трех возможных расположений (*System*, *All Users* или *Current*), PowerShell автоматически увидит это и выполнит импорт.

Сначала создадим папку для модуля. Она должна называться так же, как и сам модуль. Расположим наш модуль так что бы он был доступен для всех пользователей системы. 

```powershell
cd 'C:\Program Files\WindowsPowerShell\Modules\'
mkdir Test
```

Создадим пустой файл .psm1, который будет содержать функции

```powershell
Add-Content Test.psm1
```

Затем создадим манифест модуля

```powershell
New-ModuleManifest Test.psd1
```

На этом этапе PowerShell уже видит ваш модуль, но не экспортированные команды

```powershell
Get-Module -ListAvailable MyTest
```

`PowerShell` экспортировал все команды внутри вашего модуля и сделал их доступными для использования. Если вы хотите пойти дальше и выбрать команды для экспорта, то откройте манифест модуля и найдите ключ `FunctionsToExport`. В нем вы сможете определить через запятую все команды для экспорта. Делать это не обязательно, но такой метод позволяет более тонко настраивать экспорт функций модуля.

